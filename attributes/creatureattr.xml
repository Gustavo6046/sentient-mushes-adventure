<?xml version="1.0"?>
<default>
    <flag name="living" />
    <attribute key="dead" value="False" />
    
    <static name="speed" value="0.4" />
    <static name="moveSpeed" value="0.5" />
    <static name="hostility" value="0" />
    <static name="courage" value="1" />
    <static name="sociality" value="5" />
    <static name="leadership" value="0" />
    <static name="dangerousness" value="15" /> <!-- uses health scale -->
    <static name="flammable" value="True" />
    
    <static name="specialMoveFunc" value="None" />
    <static name="rangedAttackFunc" value="None" />
    <static name="meleeAttackFunc" value="None" />
    
    <static name="isPlayer" value="False" />

    <attribute key="health" value="100" /> # default health amount
    <attribute key="speedModifier" value="1" />
    <attribute key="mush" value="False" />
    <attribute key="humor" value="0.5" /> <!-- open scale, but general between 0 to 1 -->
    <attribute key="inventory" value="{}" />
    
    <attribute key="burning" value="False" />
    
    <declare key="instigator" />
    <declare key="burnInstigator" />    
    <declare key="target" />
    <declare key="destination" />
    
    <attribute key="friends" value="[]" />
    
    <item name="raw steak">
        <flag name="food" />
    </item>
    
    <function name="creature_tick">
        import random
        
        def weighted_random(l):
            if not isinstance(l, list):
                return None
            
            tot = sum(map(lambda x: x[1], l), 0)
            
            if tot == 0:
                return None
            
            r = random.uniform(0, tot)
            t = .0
            
            for d in l:
                t += d[1]
                
                if r &lt; t:
                    return d[0]
                
            print(r, t)    
            return None # something weird happened!
        
        def creature_tick(entity):
            # print('[DEBUG]', entity, 'creature tick.')
            # print('[DEBUG] * Life check...')
        
            if entity['dead']:
                return
                
            # print('[DEBUG]   Not dead.')
        
            if entity['burning'] and random.random() &lt;= 0.5:
                dmg = random.uniform(2, 9)
                entity.world.broadcast(1, "Ouch! ", entity, " is taking burn damage!")
                entity['instigator'] = entity['burnInstigator']
                entity.call("take_damage", dmg)
                
            if entity['burning'] and random.random() &lt;= 0.15:
                entity['burning'] = False
                entity.world.broadcast(1, entity, "'s flames have extinguished naturally.")
                
            # print('[DEBUG] * Player check....')
                
            if entity['isPlayer']:
                return
                
            # print('[DEBUG]   Not player.')
                
            if entity['destination'] and entity['destination'] != entity.place and not entity['target']:
                entity.call('pathmove', entity['destination'])
                
            else:
                if not entity['target']:
                    # Hostility.
                    strangers = tuple(filter(lambda e: (e.type.name != entity.type.name or e['mush'] != entity['mush']) and ((entity['dangerousness'] + entity['health']) * entity['courage'] &gt;= (e['dangerousness'] + e['health']) * e['courage']) and e.place == entity.place, entity.world.all_in_place(entity.place)))
                    
                    if random.random() * 20 &lt;= entity['hostility'] + 10 - entity['humor'] * 10 and len(strangers) > 0:
                        entity['target'] = random.choice(strangers).id
                        entity.world.broadcast(1, entity, ' suddenly turns to attack ', entity.world.from_id(entity['target']), '!')
                        entity.call('pick_attack')
                        
                    ## Sociality.
                    friends = tuple(filter(lambda e: e.type.name == entity.type.name and e.place == entity.place, entity.world.all_in_place(entity.place)))
                    
                    if entity['mush']:
                        # Once mush, always mush ;)
                        friends = tuple(set(friends) | set(filter(lambda e: e['mush'] and e.place == entity.place, entity.world.all_in_place(entity.place))))
                    
                    friends = tuple(set(friends) - {entity})
                    friends = tuple(filter(lambda f: f.id not in entity['friends'] and f['mush'] == entity['mush'], friends))
                    
                    if random.random() * 10 &lt;= entity['sociality'] * entity['humor'] and len(friends) > 0:
                        f = random.choice(friends)
                        fl = entity['friends']
                        fl.append(f.id)
                        entity['friends'] = fl
                        entity.world.broadcast(-1, entity, " made a new friend: ", f, "!")
                        
                    # Following friends.
                    if len(entity['friends']) > 0 and random.random() * 10 &lt;= entity['humor'] * 8 + 2:
                        to_follow = weighted_random(list({e: e['leadership'] for e in map(lambda e: entity.world.from_id(e), entity['friends'])}.items()))
                        
                        if to_follow:
                            entity.call('pathmove', to_follow.place)
    </function>
    
    <function name="flee">
        import random
    
        def flee(entity, other=None):
            if not entity['target'] or entity['dead']:
                return
                
            targ = entity.world.from_id(entity['target'])
                
            possib = set()
            
            for p in entity.world.paths:
                if entity.place in p:
                    possib |= p
                    
            possib -= {entity.place, targ.place}
            
            if len(possib) > 0:
                place = random.choice(tuple(possib))
                entity.world.broadcast(0, entity, " fled from ", targ, " towards ", place, "!")
                entity.call('move', place)
                
    </function>
    
    <function name="pick_attack">
        import random
    
        def pick_attack(entity):
            if not entity['target'] or entity['dead'] or entity.world.from_id(entity['target']).place != entity.place:
                return
                
            if (entity['dangerousness'] + entity['health']) * entity['courage'] &lt; (entity.world.from_id(entity['target'])['dangerousness'] + entity.world.from_id(entity['target'])['health']) * entity.world.from_id(entity['target'])['courage']:
                entity.call('flee')
            
            else:
                # print("{}  r={}  m={}  v={}".format(str(entity), entity['rangedAttackFunc'], entity['meleeAttackFunc'], entity.variant['attr']))
            
                if entity.world.from_id(entity['target'])['size'] &lt;= entity['size'] and entity['rangedAttackFunc'] and random.random() &lt;= 0.7:
                    entity.call(entity['rangedAttackFunc'])
                    
                elif entity['meleeAttackFunc']:
                    entity.call(entity['meleeAttackFunc'])
                    
                elif random.random() &lt;= entity['courage']:
                    entity.call('flee')
    </function>
    
    <function name="move">
        import random
    
        def move(entity, place):
            if place == entity.place:
                return
                
            possib = set() 
            
            for path in entity.world.paths:
                if entity.place in path:
                    possib |= path
                    
            if place in possib and random.random() &lt;= entity['moveSpeed']:
                entity.set_place(place)
                entity.world.broadcast(0, entity, " has just moved to ", place, "!")
    </function>
    
    <function name="pathmove">
        import random
    
        def neighbor_paths(place, world):
            res = set()
        
            for p in world.paths:
                if place in p:
                    res |= p
                    
            res -= {place}
            
            return res
    
        def pathmove(entity, navdest):
            if entity['dead'] or entity['place'] == navdest:
                return
        
            open = [entity.place]
            closed = set()
            come_from = {entity.place: None}
            p = None
            
            while navdest not in open and len(open) > 0:
                cur = open.pop()
            
                for n in neighbor_paths(cur, entity.world):
                    if n in closed:
                        continue
                
                    come_from[n] = cur
                
                    if navdest in n:
                        p = n
                        break
                    
                    for pl in n:
                        open.append(pl)
                    
                    closed.add(n)
                    
            if p is None:
                entity.world.broadcast(0, entity, " can't find a path to ", navdest, "!")
                return
                
            path = []
            
            c = navdest
            while c is not None:
                print(c, entity.place)
                path.append(c)
                c = come_from[c]
                
            entity.call('move', path[0])    
            return path[0]
    </function>
    
    <function name="tick">
        def tick(entity):
            entity.call('creature_tick')
    </function>
    
    <function name="attack">
        import random
    
        def attack(entity, other, damage):
            if entity['dead'] or entity['place'] != other['place']:
                return
        
            if random.random() * 0.5 + entity['humor'] &lt;= other['speed']:
                entity.world.broadcast(2, entity, " tried to attack ", other, "! It missed!")
                entity['humor'] -= 0.08
                return
                
            other['instigator'] = entity.id
            entity.world.broadcast(2, entity, " attacks ", other, "!")
            other.call('take_damage', damage)
    </function>
    
    <function name="take_damage">
        def take_damage(entity, damage):
            if entity['dead']:
                return
        
            for i in entity['inventory'].keys():
                if entity['inventory'].get(i) &gt; 0 and 'modify_damage' in entity.world.item_type(i).functions:
                    damage = entity.world.item_type(i).functions['modify_damage'](entity, world, damage)
                    
            entity['health'] = entity['health'] - damage

            if entity['health'] &lt;= 0:
                if entity['instigator']:
                    entity.world.from_id(entity['instigator'])['humor'] = entity.world.from_id(entity['instigator'])['humor'] + 0.02 * entity.world.from_id(entity['instigator'])['hostility'] - 5
                
                    if entity.world.from_id(entity['instigator'])['obituary']:
                        entity.world.broadcast(2, '* ' + entity.world.from_id(entity['instigator'])['obituary'].format(killer=entity.world.from_id(entity['instigator']), victim=entity))
                        
                    else:
                         entity.world.broadcast(2, '* ', entity, " took ", damage, " damage from ", entity.world.from_id(entity['instigator']), " and died!")
            
                else:
                    entity.world.broadcast(2, entity, '* ', " took ", damage, " damage and died!")
                    
                entity['dead'] = True
            
            else:
                entity['humor'] -= damage / entity['health'] / 1.5
            
                if entity['instigator']:
                    entity['humor'] -= 7
                
                    entity.world.broadcast(1, entity, " took ", damage, " damage!")
                    
                    if not entity['target'] or entity.world.from_id(entity['instigator'])['dangerousness'] + entity.world.from_id(entity['instigator'])['health'] &gt; entity.world.from_id(entity['target'])['dangerousness'] + entity.world.from_id(entity['target'])['health']:
                        entity['target'] = entity['instigator']
                        
                    entity['instigator'] = None
                    
                else:
                    entity.world.broadcast(0, entity, " took ", damage, " damage!")
            
    </function>
    
    <function name="heal">
        def heal(entity, other, amount):
            if entity['dead']:
                return
        
            if entity['place'] == other['place']:
                if entity.id == other.id:
                    entity.world.broadcast(0, entity, " is healing itself by ", amount, " hitpoints!")
                
                else:
                    entity.world.broadcast(1, entity, " is healing ", other, " by ", amount, " hitpoints!")
                    
                other['health'] = other['health'] + amount
    </function>
</default>